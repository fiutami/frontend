#!/usr/bin/env node

/**
 * Figma Design Tokens Sync
 *
 * Sincronizza design tokens da Figma e genera file SCSS
 *
 * Usage:
 *   node .claude/scripts/figma-sync-tokens.js
 *   npm run figma:sync-tokens
 */

const fs = require('fs');
const path = require('path');

// Load configuration
function loadConfig() {
  const configPath = path.join(__dirname, '../../.figma/export-config.json');
  const mappingPath = path.join(__dirname, '../../.figma/token-mapping.json');

  if (!fs.existsSync(configPath)) {
    console.error('âŒ Configuration not found: .figma/export-config.json');
    process.exit(1);
  }

  if (!fs.existsSync(mappingPath)) {
    console.error('âŒ Token mapping not found: .figma/token-mapping.json');
    process.exit(1);
  }

  return {
    config: JSON.parse(fs.readFileSync(configPath, 'utf8')),
    mapping: JSON.parse(fs.readFileSync(mappingPath, 'utf8'))
  };
}

// Mock function to fetch Figma tokens (requires Figma API)
function fetchFigmaTokens(fileId, accessToken) {
  console.log('ðŸ“¡ Fetching tokens from Figma...');
  console.log('âš ï¸  Note: This requires Figma API integration via MCP server\n');

  // In a real implementation, this would call Figma API
  // For now, return mock tokens that match existing design
  return {
    colors: {
      'color/primary/500': '#F5A623',
      'color/accent/500': '#4A90E2',
      'color/text/primary': '#111111',
      'color/text/secondary': '#666666',
      'color/text/inverse': '#FFFFFF',
      'color/background/primary': '#FFFFFF',
      'color/background/secondary': '#F5F5F5',
    },
    spacing: {
      'spacing/xs': '8px',
      'spacing/sm': '12px',
      'spacing/md': '16px',
      'spacing/lg': '24px',
      'spacing/xl': '32px',
      'spacing/2xl': '48px',
    },
    typography: {
      'typography/h1/size': '48px',
      'typography/h1/weight': '700',
      'typography/h1/lineHeight': '1.2',
      'typography/h2/size': '36px',
      'typography/h2/weight': '600',
      'typography/h2/lineHeight': '1.3',
      'typography/body/size': '16px',
      'typography/body/weight': '400',
      'typography/body/lineHeight': '1.5',
    },
    shadows: {
      'shadow/sm': '0 1px 2px rgba(0, 0, 0, 0.05)',
      'shadow/md': '0 4px 6px rgba(0, 0, 0, 0.1)',
      'shadow/lg': '0 10px 15px rgba(0, 0, 0, 0.1)',
      'shadow/xl': '0 20px 25px rgba(0, 0, 0, 0.15)',
    },
    borderRadius: {
      'radius/sm': '4px',
      'radius/md': '8px',
      'radius/lg': '12px',
      'radius/xl': '16px',
      'radius/full': '9999px',
    },
    transitions: {
      'transition/fast': 'all 0.15s ease',
      'transition/base': 'all 0.2s ease',
      'transition/slow': 'all 0.3s ease',
    }
  };
}

// Map Figma tokens to SCSS variables
function mapTokensToSCSS(tokens, mapping) {
  const scss = {};

  Object.keys(tokens).forEach(category => {
    const categoryMapping = mapping.mappings[category];
    if (!categoryMapping) return;

    scss[category] = {};

    Object.keys(tokens[category]).forEach(tokenKey => {
      const scssVar = categoryMapping.mapping?.[tokenKey] ||
                     tokenKey.replace(categoryMapping.figmaPrefix, categoryMapping.scssPrefix);
      scss[category][scssVar] = tokens[category][tokenKey];
    });
  });

  return scss;
}

// Generate SCSS file
function generateSCSSFile(mappedTokens, outputPath) {
  const timestamp = new Date().toISOString();

  let content = `// AUTO-GENERATED FROM FIGMA - DO NOT EDIT MANUALLY\n`;
  content += `// Last sync: ${timestamp}\n`;
  content += `// Generated by: .claude/scripts/figma-sync-tokens.js\n\n`;

  Object.keys(mappedTokens).forEach(category => {
    content += `// ${category.charAt(0).toUpperCase() + category.slice(1)}\n`;

    const tokens = mappedTokens[category];
    Object.keys(tokens).forEach(variable => {
      content += `${variable}: ${tokens[variable]};\n`;
    });

    content += '\n';
  });

  // Add helpful comment at the end
  content += `// Usage:\n`;
  content += `// Import in your component SCSS:\n`;
  content += `// @import 'src/styles/tokens-figma';\n`;
  content += `//\n`;
  content += `// Then use tokens:\n`;
  content += `// .my-component {\n`;
  content += `//   color: $color-primary-500;\n`;
  content += `//   padding: $spacing-md;\n`;
  content += `// }\n`;

  fs.writeFileSync(outputPath, content);
}

// Main execution
function main() {
  console.log('ðŸŽ¨ Figma Design Tokens Sync\n');

  const { config, mapping } = loadConfig();

  // Fetch tokens from Figma
  const figmaFileId = config.figma?.fileId || 'REPLACE_WITH_YOUR_FIGMA_FILE_ID';
  const accessToken = process.env.FIGMA_PERSONAL_ACCESS_TOKEN;

  if (figmaFileId === 'REPLACE_WITH_YOUR_FIGMA_FILE_ID') {
    console.log('âš ï¸  Figma File ID not configured');
    console.log('   Update .figma/export-config.json with your Figma file ID\n');
  }

  if (!accessToken) {
    console.log('âš ï¸  FIGMA_PERSONAL_ACCESS_TOKEN not set');
    console.log('   Set environment variable or configure in Claude Desktop config\n');
    console.log('ðŸ“ Using mock tokens for demonstration...\n');
  }

  const tokens = fetchFigmaTokens(figmaFileId, accessToken);

  console.log('ðŸ”„ Mapping tokens to SCSS...');
  const mappedTokens = mapTokensToSCSS(tokens, mapping);

  console.log('ðŸ“ Generating SCSS file...');
  const outputPath = path.join(
    __dirname,
    '../../',
    config.exports.designTokens.outputFile
  );

  generateSCSSFile(mappedTokens, outputPath);

  console.log(`âœ… Tokens synchronized successfully!`);
  console.log(`ðŸ“„ Output: ${config.exports.designTokens.outputFile}\n`);

  // Show summary
  const totalTokens = Object.values(mappedTokens).reduce(
    (sum, category) => sum + Object.keys(category).length,
    0
  );

  console.log('ðŸ“Š Summary:');
  Object.keys(mappedTokens).forEach(category => {
    const count = Object.keys(mappedTokens[category]).length;
    console.log(`   ${category}: ${count} tokens`);
  });
  console.log(`   Total: ${totalTokens} tokens\n`);

  console.log('ðŸ’¡ Next steps:');
  console.log('   1. Review generated tokens in: src/styles/_tokens-figma.scss');
  console.log('   2. Import in your components:');
  console.log('      @import "src/styles/tokens-figma";');
  console.log('   3. Use tokens in your styles:');
  console.log('      color: $color-primary-500;\n');
}

// Run if called directly
if (require.main === module) {
  main();
}

module.exports = { fetchFigmaTokens, mapTokensToSCSS, generateSCSSFile };
