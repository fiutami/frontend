<div class="register-pet">
  <!-- Header -->
  <header class="register-pet__header">
    <app-back-button
      variant="solid"
      (clicked)="onBack()">
    </app-back-button>
  </header>

  <!-- Main content -->
  <main class="register-pet__content">
    <h1 class="register-pet__title">{{ 'onboarding.registerPet.title' | translate }}</h1>

    <!-- Photo upload section -->
    <div class="register-pet__photo-section">
      <div
        class="register-pet__photo-upload"
        (click)="triggerFileInput()"
        [class.register-pet__photo-upload--has-photo]="photoPreview()"
        [class.register-pet__photo-upload--transparent]="isBgRemoved()">
        @if (photoPreview()) {
          <img
            [src]="photoPreview()"
            [alt]="'onboarding.registerPet.addPhoto' | translate"
            class="register-pet__photo-preview" />
          @if (isRemovingBg()) {
            <div class="register-pet__photo-processing">
              <span class="register-pet__spinner-small"></span>
            </div>
          }
          <button
            type="button"
            class="register-pet__photo-remove"
            (click)="removePhoto($event)"
            [attr.aria-label]="'common.remove' | translate">
            &times;
          </button>
        } @else {
          <div class="register-pet__photo-placeholder-inner">
            <span class="register-pet__photo-icon">ðŸ“·</span>
            <span class="register-pet__photo-text">{{ 'onboarding.registerPet.addPhoto' | translate }}</span>
          </div>
        }
      </div>
      <input
        #fileInput
        type="file"
        accept="image/jpeg,image/png,image/webp"
        (change)="onFileSelected($event)"
        hidden />
      @if (selectedFile) {
        <button type="button" class="register-pet__bg-toggle" (click)="toggleRemoveBg()" [disabled]="isRemovingBg()">
          <span class="register-pet__bg-toggle-track" [class.register-pet__bg-toggle-track--active]="removeBgEnabled()">
            <span class="register-pet__bg-toggle-thumb"></span>
          </span>
          <span class="register-pet__bg-toggle-label">Rimuovi sfondo</span>
        </button>
      }
      @if (uploadError()) {
        <p class="register-pet__photo-error">{{ uploadError() }}</p>
      } @else {
        <p class="register-pet__photo-hint">{{ 'onboarding.registerPet.photoHint' | translate }}</p>
      }
    </div>

    <!-- Error message -->
    @if (errorMessage()) {
      <div class="register-pet__error">
        {{ errorMessage() }}
      </div>
    }

    <!-- Form -->
    <form
      class="register-pet__form"
      [formGroup]="petForm"
      (ngSubmit)="onSubmit()">

      <!-- Nome -->
      <div class="register-pet__field">
        <label class="register-pet__label" for="nome">
          {{ 'onboarding.registerPet.petName' | translate }} <span class="register-pet__required">*</span>
        </label>
        <input
          type="text"
          id="nome"
          formControlName="nome"
          class="register-pet__input"
          [placeholder]="'onboarding.registerPet.petNamePlaceholder' | translate"
          [class.register-pet__input--error]="getFieldError('nome')"
          maxlength="100" />
        @if (getFieldError('nome')) {
          <span class="register-pet__field-error">{{ getFieldError('nome') }}</span>
        }
      </div>

      <!-- Specie -->
      <div class="register-pet__field">
        <label class="register-pet__label" for="specie">
          {{ 'onboarding.registerPet.species' | translate }} <span class="register-pet__required">*</span>
        </label>
        @if (isLoadingSpecies()) {
          <div class="register-pet__loading-field">
            <span class="register-pet__spinner-small"></span>
            {{ 'onboarding.registerPet.loadingSpecies' | translate }}
          </div>
        } @else if (speciesError()) {
          <div class="register-pet__field-error-box">
            {{ speciesError() }}
          </div>
        } @else {
          <select
            id="specie"
            formControlName="specie"
            class="register-pet__select"
            [class.register-pet__select--error]="getFieldError('specie')">
            <option value="" disabled>{{ 'onboarding.registerPet.speciesPlaceholder' | translate }}</option>
            @for (option of speciesOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
          @if (getFieldError('specie')) {
            <span class="register-pet__field-error">{{ getFieldError('specie') }}</span>
          }
        }
      </div>

      <!-- Razza (hidden when breedPolicy is 'None') -->
      @if (selectedBreedPolicy() !== 'None') {
        <div class="register-pet__field">
          <label class="register-pet__label" for="razza">
            @if (selectedBreedPolicy() === 'Required') {
              {{ 'onboarding.registerPet.breedOptional' | translate }} <span class="register-pet__required">*</span>
            } @else {
              {{ 'onboarding.registerPet.breedOptional' | translate }}
            }
          </label>
          @if (isLoadingBreeds()) {
            <div class="register-pet__loading-field">
              <span class="register-pet__spinner-small"></span>
              {{ 'onboarding.registerPet.loadingBreeds' | translate }}
            </div>
          } @else if (breedOptions.length > 0) {
            <select
              id="razza"
              formControlName="razza"
              class="register-pet__select"
              [class.register-pet__select--error]="getFieldError('razza')">
              <option value="">{{ 'onboarding.registerPet.breedPlaceholder' | translate }}</option>
              @for (option of breedOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
            @if (getFieldError('razza')) {
              <span class="register-pet__field-error">{{ getFieldError('razza') }}</span>
            }
          } @else {
            <input
              type="text"
              id="razza"
              formControlName="razza"
              class="register-pet__input"
              [placeholder]="'onboarding.registerPet.breedPlaceholder' | translate" />
          }
        </div>

        <!-- Variant label (only for Mixed/Hybrid breeds) -->
        @if (showVariantLabel()) {
          <div class="register-pet__field">
            <label class="register-pet__label" for="variantLabel">{{ 'onboarding.registerPet.variantLabel' | translate }}</label>
            <input
              type="text"
              id="variantLabel"
              formControlName="variantLabel"
              class="register-pet__input"
              [placeholder]="'onboarding.registerPet.variantLabelPlaceholder' | translate"
              maxlength="60" />
            <p class="register-pet__photo-hint">{{ 'onboarding.registerPet.variantLabelHint' | translate }}</p>
          </div>
        }
      }

      <!-- Sesso -->
      <div class="register-pet__field">
        <label class="register-pet__label">
          {{ 'onboarding.registerPet.gender' | translate }} <span class="register-pet__required">*</span>
        </label>
        <div class="register-pet__radio-group">
          <label class="register-pet__radio">
            <input
              type="radio"
              formControlName="sesso"
              value="male" />
            <span class="register-pet__radio-label">{{ 'onboarding.registerPet.male' | translate }}</span>
          </label>
          <label class="register-pet__radio">
            <input
              type="radio"
              formControlName="sesso"
              value="female" />
            <span class="register-pet__radio-label">{{ 'onboarding.registerPet.female' | translate }}</span>
          </label>
        </div>
        @if (getFieldError('sesso')) {
          <span class="register-pet__field-error">{{ getFieldError('sesso') }}</span>
        }
      </div>

      <!-- Data di nascita -->
      <div class="register-pet__field">
        <label class="register-pet__label" for="dataNascita">{{ 'onboarding.registerPet.birthDate' | translate }}</label>
        <input
          type="date"
          id="dataNascita"
          formControlName="dataNascita"
          class="register-pet__input" />
      </div>

      <!-- Peso -->
      <div class="register-pet__field">
        <label class="register-pet__label" for="peso">{{ 'onboarding.registerPet.weight' | translate }}</label>
        <input
          type="number"
          id="peso"
          formControlName="peso"
          class="register-pet__input"
          [placeholder]="'onboarding.registerPet.weightPlaceholder' | translate"
          step="0.1"
          min="0" />
      </div>

      <!-- Colore -->
      <div class="register-pet__field">
        <label class="register-pet__label" for="colore">{{ 'onboarding.registerPet.color' | translate }}</label>
        <input
          type="text"
          id="colore"
          formControlName="colore"
          class="register-pet__input"
          [placeholder]="'onboarding.registerPet.colorPlaceholder' | translate"
          maxlength="50" />
      </div>

      <!-- Segni particolari -->
      <div class="register-pet__field">
        <label class="register-pet__label" for="segniParticolari">{{ 'onboarding.registerPet.specialMarks' | translate }}</label>
        <textarea
          id="segniParticolari"
          formControlName="segniParticolari"
          class="register-pet__textarea"
          [placeholder]="'onboarding.registerPet.specialMarksPlaceholder' | translate"
          rows="3"
          maxlength="200"></textarea>
      </div>

      <!-- Submit button -->
      <button
        type="submit"
        class="register-pet__submit"
        [disabled]="isLoading() || isUploading() || isLoadingSpecies() || speciesError() || isRemovingBg()">
        @if (isUploading()) {
          <span class="register-pet__spinner"></span>
          {{ 'onboarding.registerPet.uploadingPhoto' | translate }}
        } @else if (isLoading()) {
          <span class="register-pet__spinner"></span>
          {{ 'onboarding.registerPet.registering' | translate }}
        } @else {
          {{ 'onboarding.registerPet.submit' | translate }}
        }
      </button>
    </form>
  </main>
</div>
