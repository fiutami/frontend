<!-- Questionnaire Result Page -->
<div class="result-page">

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>{{ matchingState().message || ('questionnaire.result.loading' | translate) }}</p>
      @if (embeddingState().status === 'loading') {
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="embeddingState().progress"></div>
        </div>
        <p class="progress-text">{{ embeddingState().message }}</p>
      }
    </div>
  }

  <!-- Results -->
  @if (!isLoading() && profile()) {
    <div class="result-content">

      <!-- Header -->
      <header class="result-header">
        <div class="success-icon">ğŸ‰</div>
        <h1>{{ 'questionnaire.result.title' | translate }}</h1>
        <p class="subtitle">{{ 'questionnaire.result.subtitle' | translate }}</p>
      </header>

      <!-- Species Badge -->
      <div class="species-badge">
        <span class="species-icon">
          @switch (selectedSpecies()) {
            @case ('dog') { ğŸ• }
            @case ('cat') { ğŸˆ }
            @case ('small_mammal') { ğŸ¹ }
            @case ('bird') { ğŸ¦œ }
            @case ('fish') { ğŸ  }
            @default { ğŸ¾ }
          }
        </span>
        <span class="species-name">
          {{ 'questionnaire.species.' + selectedSpecies() | translate }}
        </span>
      </div>

      <!-- Breed Recommendations -->
      @if (hasResults()) {
        <section class="recommendations">
          <h2>{{ 'questionnaire.result.recommendations' | translate }}</h2>

          @for (result of topRecommendations(); track trackByBreedId($index, result)) {
            <div class="breed-card" [class.expanded]="expandedBreedId() === result.breed.id">

              <!-- Card Header -->
              <div class="breed-header" (click)="toggleExplanation(result)">
                <div class="breed-info">
                  @if (result.breed.imageUrl) {
                    <img [src]="result.breed.imageUrl" [alt]="result.breed.name" class="breed-image">
                  } @else {
                    <div class="breed-placeholder">
                      @switch (result.breed.species) {
                        @case ('dog') { ğŸ• }
                        @case ('cat') { ğŸˆ }
                        @default { ğŸ¾ }
                      }
                    </div>
                  }
                  <div class="breed-text">
                    <h3>{{ result.breed.name }}</h3>
                    <p class="breed-description">{{ result.breed.description | slice:0:80 }}...</p>
                  </div>
                </div>
                <div class="breed-score" [class]="getScoreClass(result.score)">
                  <span class="score-value">{{ result.score }}%</span>
                  <span class="score-label">match</span>
                </div>
              </div>

              <!-- Match Reasons -->
              @if (result.matchReasons.length > 0) {
                <div class="match-reasons">
                  @for (reason of result.matchReasons.slice(0, 3); track reason.reason) {
                    <span class="reason-chip" [class]="reason.impact">
                      @if (reason.impact === 'positive') { âœ“ }
                      @else if (reason.impact === 'warning') { âš  }
                      {{ reason.reason }}
                    </span>
                  }
                </div>
              }

              <!-- Expanded Content -->
              @if (expandedBreedId() === result.breed.id) {
                <div class="breed-expanded">
                  <!-- AI Explanation -->
                  @if (isLoadingExplanation()) {
                    <div class="explanation-loading">
                      <span class="mini-spinner"></span>
                      {{ 'onboarding.questionnaireResult.loadingExplanation' | translate }}
                    </div>
                  } @else if (breedExplanation()) {
                    <div class="explanation">
                      <span class="explanation-icon">ğŸ•</span>
                      <p>{{ breedExplanation() }}</p>
                    </div>
                  }

                  <!-- Tradeoffs -->
                  @if (result.tradeoffs.length > 0) {
                    <div class="tradeoffs">
                      <h4>{{ 'onboarding.questionnaireResult.toConsider' | translate }}</h4>
                      @for (tradeoff of result.tradeoffs; track tradeoff.aspect) {
                        <div class="tradeoff-item" [class]="tradeoff.severity">
                          <span class="tradeoff-icon">
                            @if (tradeoff.severity === 'high') { âš ï¸ }
                            @else if (tradeoff.severity === 'medium') { â„¹ï¸ }
                            @else { ğŸ’¡ }
                          </span>
                          <span>{{ tradeoff.description }}</span>
                        </div>
                      }
                    </div>
                  }

                  <!-- Actions -->
                  <div class="breed-actions">
                    <button class="btn-view" (click)="viewBreedDetails(result.breed.id)">
                      {{ 'onboarding.questionnaireResult.discoverMore' | translate }}
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </section>
      } @else {
        <!-- No Results -->
        <section class="no-results">
          <div class="no-results-icon">ğŸ”</div>
          <h3>{{ 'onboarding.questionnaireResult.noBreedFound' | translate }}</h3>
          <p>{{ 'onboarding.questionnaireResult.noBreedFoundDesc' | translate }}</p>
        </section>
      }

      <!-- Profile Summary -->
      <section class="profile-summary">
        <h2>{{ 'questionnaire.result.your_profile' | translate }}</h2>
        <div class="summary-grid">
          @for (item of profileSummary(); track item.key) {
            <div class="summary-item">
              <span class="item-label">{{ item.key | translate }}</span>
              <span class="item-value">{{ 'questionnaire.values.' + item.value | translate }}</span>
            </div>
          }
        </div>
      </section>

      <!-- Actions -->
      <div class="result-actions">
        <button class="btn-primary" (click)="exploreCatalog()">
          {{ 'questionnaire.result.explore_catalog' | translate }}
        </button>
        <button class="btn-secondary" (click)="startOver()">
          {{ 'questionnaire.result.start_over' | translate }}
        </button>
        <button class="btn-text" (click)="goHome()">
          {{ 'questionnaire.result.go_home' | translate }}
        </button>
      </div>

    </div>

    <!-- Fiuto Chat -->
    <app-fiuto-chat
      [userProfile]="profile() ?? {}"
      [phase]="'results'"
    ></app-fiuto-chat>
  }

</div>
