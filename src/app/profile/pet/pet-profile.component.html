<div class="pet-profile">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>{{ 'petProfile.loading' | translate }}</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <div class="error-container">
      <p class="error-message">{{ error() }}</p>
      <button class="btn-primary" (click)="goBack()">
        {{ 'common.back' | translate }}
      </button>
    </div>
  }

  <!-- Profile Content -->
  @if (pet() && !loading()) {
    <!-- Header with Title and Drawer -->
    <header class="profile-header">
      <div class="profile-header__nav">
        <button class="btn-back" (click)="goBack()" aria-label="Indietro">
          <span class="icon">&#8592;</span>
        </button>
        <h1 class="profile-header__title">Profilo</h1>
        <button class="btn-drawer" (click)="openDrawer()" aria-label="Menu">
          @if (pet()!.profilePhotoUrl) {
            <img [src]="pet()!.profilePhotoUrl" [alt]="pet()!.name" class="drawer-avatar" />
          } @else {
            <div class="drawer-avatar placeholder">{{ pet()!.name.charAt(0) }}</div>
          }
        </button>
      </div>

      <!-- Pet Dots Navigation -->
      <div class="profile-header__dots">
        @for (p of userPets(); track p.id) {
          <button
            class="pet-dot"
            [class.active]="p.id === pet()?.id"
            (click)="switchPet(p.id)"
            [attr.aria-label]="'Passa a ' + p.name">
          </button>
        }
        <button class="pet-dot pet-dot--add" (click)="onAddPet()" aria-label="Aggiungi pet">
          <span>+</span>
        </button>
      </div>
    </header>

    <!-- Main Content (Scrollable) -->
    <main class="profile-content">
      <!-- Hero Section: Photo + Side Icons -->
      <section class="profile-hero">
        <!-- Pet Photo (Central) -->
        <div class="profile-hero__photo-wrapper">
          <div class="profile-hero__photo">
            @if (pet()!.profilePhotoUrl) {
              <img [src]="pet()!.profilePhotoUrl" [alt]="pet()!.name" />
            } @else {
              <div class="profile-photo-placeholder">
                <span>{{ pet()!.name.charAt(0) }}</span>
              </div>
            }
          </div>

          <!-- Pet Name & Details -->
          <div class="profile-hero__info">
            <h2 class="pet-name">{{ pet()!.name }}</h2>
            <p class="pet-breed">{{ pet()!.species }} - {{ pet()!.breed }}</p>
          </div>
        </div>

        <!-- Side Action Icons (Right Column) -->
        <aside class="profile-hero__actions">
          <app-profile-icon
            icon="calendar"
            variant="circular"
            ariaLabel="Calendario"
            (onClick)="navigateTo('/calendar')" />
          <app-profile-icon
            icon="notifications"
            variant="circular"
            ariaLabel="Notifiche"
            (onClick)="navigateTo('/notifications')" />
          <app-profile-icon
            icon="edit"
            variant="circular"
            ariaLabel="Modifica profilo"
            (onClick)="goToEdit()" />
          <app-profile-icon
            icon="messages"
            variant="circular"
            ariaLabel="Messaggi"
            (onClick)="navigateTo('/chat')" />
          <app-profile-icon
            icon="bookmark"
            variant="circular"
            ariaLabel="Salvati"
            (onClick)="navigateTo('/saved')" />
        </aside>
      </section>

      <!-- Info Boxes Section (Blue SVG boxes) - 5 boxes per UX doc -->
      <section class="profile-info-boxes">
        <app-profile-icon
          icon="sex"
          variant="info"
          [label]="getSexLabel(pet()!.sex)"
          ariaLabel="Sesso" />
        <app-profile-icon
          icon="age"
          variant="info"
          [label]="pet()!.age"
          ariaLabel="Età" />
        <app-profile-icon
          icon="pet_age"
          variant="info"
          [label]="humanAge() ? humanAge()!.humanYears + ' anni' : '-'"
          ariaLabel="Età in anni umani" />
        <app-profile-icon
          icon="weight"
          variant="info"
          [label]="formatWeight(pet()!.weight)"
          ariaLabel="Peso" />
        <app-profile-icon
          icon="breed"
          variant="info"
          [label]="pet()!.breed"
          ariaLabel="Razza" />
      </section>

      <!-- CTA Buttons Section (Golden Buttons) -->
      <section class="profile-cta-buttons">
        <app-profile-icon
          icon="foto"
          variant="cta"
          ariaLabel="Banda Pelosa - Gallery"
          (onClick)="navigateTo('/profile/pet/' + petId + '/gallery')" />
        <app-profile-icon
          icon="doc"
          variant="cta"
          ariaLabel="Fatti Bestiali - Info"
          (onClick)="navigateTo('/profile/pet/' + petId + '/facts')" />
        <app-profile-icon
          icon="friends"
          variant="cta"
          ariaLabel="Rullino Feroce - Amici"
          (onClick)="navigateTo('/profile/pet/' + petId + '/friends')" />
      </section>

      <!-- Promo Button (FIUTAMI Plus) -->
      <button class="profile-promo-btn" (click)="navigateTo('/premium')">
        <img src="assets/icons/profile/promo/Btn_Promo.png" alt="FIUTAMI Plus" />
      </button>

      <!-- Map Preview Section -->
      <section class="profile-map-preview">
        <p class="profile-map-preview__title">Testa e prova la mappa interattiva</p>
        <div class="profile-map-preview__container">
          <div class="map-preview-placeholder">
            <img src="assets/images/map-preview.png" alt="Anteprima mappa" onerror="this.style.display='none'" />
          </div>
          <button class="btn-fiuta" (click)="navigateTo('/map')">
            <span class="btn-fiuta__icon">&#128269;</span>
            <span class="btn-fiuta__text">FIUTA</span>
          </button>
        </div>
      </section>

      <!-- Promo Carousel Section -->
      @if (promoCards().length > 0) {
        <section class="profile-promo-carousel">
          <div class="promo-scroll" #promoScrollContainer>
            @for (promo of promoCards(); track promo.id) {
              <div class="promo-card" (click)="onPromoClick(promo)">
                <img [src]="promo.imageUrl" [alt]="promo.title" />
              </div>
            }
          </div>
          <div class="promo-dots">
            @for (promo of promoCards(); track promo.id; let i = $index) {
              <span
                class="dot"
                [class.active]="i === activePromoIndex()"
                (click)="scrollToPromo(i)">
              </span>
            }
          </div>
        </section>
      }

      <!-- Online Friends Section -->
      <section class="profile-online-friends">
        <p class="section-intro">Scopri fiutati speciali vicino a te.</p>
        <div class="friends-scroll">
          @for (friend of onlineFriends(); track friend.id) {
            <div class="friend-avatar-card" (click)="goToFriendProfile(friend)">
              @if (friend.profilePhotoUrl) {
                <img [src]="friend.profilePhotoUrl" [alt]="friend.name" class="friend-photo" />
              } @else {
                <div class="friend-photo placeholder">{{ friend.name.charAt(0) }}</div>
              }
              <span class="online-indicator"></span>
              <p class="friend-name">{{ friend.name }}</p>
            </div>
          }
          @if (onlineFriends().length === 0) {
            <div class="no-friends-placeholder">
              <p>Nessun amico online</p>
            </div>
          }
        </div>
        <button class="btn-secondary" (click)="goToDiscover()">
          Amici Online
        </button>
      </section>
    </main>

    <!-- Mascotte FIUTO (Fixed) -->
    <button class="mascotte-fiuto" (click)="openFiutoChat()" aria-label="Parla con FIUTO">
      <img src="assets/images/fiuto-mascot.png" alt="FIUTO" />
    </button>

    <!-- Photo Upload Modal -->
    @if (showUploadModal()) {
      <app-photo-upload-modal
        [aspectRatio]="uploadAspectRatio()"
        [title]="'Aggiungi foto'"
        (confirmed)="onPhotoConfirmed($event)"
        (cancelled)="onUploadCancelled()">
      </app-photo-upload-modal>
    }

    <!-- Upload Progress Overlay -->
    @if (isUploading()) {
      <div class="upload-overlay">
        <div class="upload-progress-card">
          <div class="upload-spinner"></div>
          <p class="upload-text">
            @if (uploadProgress() > 0) {
              Caricamento {{ uploadProgress() }}%
            } @else {
              Caricamento in corso...
            }
          </p>
          <div class="upload-progress-bar">
            <div class="upload-progress-fill" [style.width.%]="uploadProgress()"></div>
          </div>
        </div>
      </div>
    }

    <!-- Upload Error Toast -->
    @if (uploadError()) {
      <div class="upload-error-toast">
        <span class="error-icon">!</span>
        <p>{{ uploadError() }}</p>
        <button type="button" (click)="uploadError.set(null)">×</button>
      </div>
    }
  }

  <!-- Bottom Tab Bar -->
  <app-bottom-tab-bar [tabs]="tabs" [activeTabId]="'pet-profile'"></app-bottom-tab-bar>
</div>
