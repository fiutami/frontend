<app-tab-page-shell-drawer
  [title]="pageTitle"
  [showBack]="true"
  (backClicked)="goBack()">

  <main class="page-content">
    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>{{ 'drawerSubscriptions.loading' | translate }}</p>
      </div>
    } @else if (hasError()) {
      <div class="error-state">
        <span class="material-icons">error_outline</span>
        <p>{{ 'drawerSubscriptions.error' | translate }}</p>
        <button class="retry-btn" (click)="loadData()">{{ 'drawerSubscriptions.retry' | translate }}</button>
      </div>
    } @else {
      <!-- Intro text -->
      <p class="intro-text">{{ 'drawerSubscriptions.introText' | translate }}</p>

      <!-- Section: Il tuo piano -->
      <div class="section-title">
        <h3>{{ 'drawerSubscriptions.yourPlan' | translate }}</h3>
        <div class="section-title__line"></div>
      </div>

      <!-- Current plan card -->
      <div class="current-plan-card">
        <div class="current-plan-card__icon">
          <span class="material-icons">card_membership</span>
        </div>
        <div class="current-plan-card__info">
          <span class="current-plan-card__label">{{ 'drawerSubscriptions.currentPlanLabel' | translate }}</span>
          <span class="current-plan-card__name">{{ currentPlanDisplayName() }}</span>
        </div>
        @if (currentPlanObj(); as plan) {
          <div class="current-plan-card__price">
            <span>{{ getPrice(plan) }}</span>
            @if (plan.monthlyPrice > 0) {
              <small>{{ getPeriodKey() | translate }}</small>
            }
          </div>
        }
      </div>

      <!-- Section: Piani disponibili -->
      <div class="section-title">
        <h3>{{ 'drawerSubscriptions.availablePlans' | translate }}</h3>
        <div class="section-title__line"></div>
      </div>

      <div class="billing-toggle">
        <span [class.active]="!isYearly()">{{ 'drawerSubscriptions.monthly' | translate }}</span>
        <button class="toggle-switch" (click)="toggleBillingCycle()" [class.yearly]="isYearly()">
          <span class="toggle-knob"></span>
        </button>
        <span [class.active]="isYearly()">
          {{ 'drawerSubscriptions.yearly' | translate }}
          <span class="discount-badge">-33%</span>
        </span>
      </div>

      <div class="plans-list">
        @for (plan of plans(); track plan.id) {
          <article
            class="plan-card"
            [class.highlighted]="plan.highlighted"
            [class.current]="isCurrentPlan(plan.id)"
          >
            @if (plan.badge) {
              <span class="plan-badge">{{ plan.badge }}</span>
            }

            <div class="plan-header" [style.background]="getPlanGradient(plan.tier)">
              <h2>{{ plan.name }}</h2>
              <p class="plan-description">{{ plan.description }}</p>
            </div>

            <div class="plan-pricing">
              <span class="price">{{ getPrice(plan) }}</span>
              @if (plan.monthlyPrice > 0) {
                <span class="period">{{ getPeriodKey() | translate }}</span>
              }
            </div>

            @if (isYearly() && plan.yearlyDiscount > 0) {
              <p class="yearly-savings">
                {{ 'drawerSubscriptions.yearlySavings' | translate: { discount: plan.yearlyDiscount } }}
              </p>
            }

            <ul class="features-list">
              @for (feature of plan.features; track feature.text) {
                <li [class.included]="feature.included" [class.excluded]="!feature.included">
                  <span class="material-icons">
                    {{ feature.included ? 'check_circle' : 'cancel' }}
                  </span>
                  {{ feature.text }}
                </li>
              }
            </ul>

            <button
              class="subscribe-btn"
              [class.current]="isCurrentPlan(plan.id)"
              [disabled]="isCurrentPlan(plan.id) || plan.monthlyPrice === 0 || isSubscribing()"
              (click)="subscribe(plan)"
            >
              @if (isSubscribing() && subscribingPlanId() === plan.id) {
                <span class="btn-spinner"></span>
              } @else {
                {{ getButtonTextKey(plan) | translate }}
              }
            </button>
          </article>
        }
      </div>

      <div class="footer-info">
        <p>{{ 'drawerSubscriptions.footerCancel' | translate }}</p>
        <p>{{ 'drawerSubscriptions.footerSecure' | translate }}</p>
      </div>
    }
  </main>

</app-tab-page-shell-drawer>
