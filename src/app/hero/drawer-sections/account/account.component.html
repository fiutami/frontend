<app-tab-page-shell-drawer
  [title]="pageTitle"
  [showBack]="true"
  (backClicked)="goBack()">

  <!-- Content -->
  <main class="account-content">
    <!-- Loading State -->
    @if (isLoading()) {
      <div class="account-loading">
        <div class="account-loading__spinner"></div>
        <p class="account-loading__text">{{ 'drawerAccount.loading' | translate }}</p>
      </div>
    }

    <!-- Error State -->
    @else if (hasError()) {
      <div class="account-error">
        <span class="material-icons account-error__icon">error_outline</span>
        <p class="account-error__text">{{ 'drawerAccount.errorLoading' | translate }}</p>
        <button class="account-error__retry" (click)="retry()" type="button">
          {{ 'drawerAccount.retry' | translate }}
        </button>
      </div>
    }

    <!-- Account Content -->
    @else {
      <!-- Account Overview Section -->
      <section class="account-section">
        <h2 class="account-section__title">
          <span class="material-icons">person</span>
          {{ 'drawerAccount.overviewTitle' | translate }}
        </h2>

        <div class="account-info-grid">
          <div class="account-info-item">
            <span class="account-info-item__label">{{ 'drawerAccount.labelEmail' | translate }}</span>
            <span class="account-info-item__value">{{ user()?.email }}</span>
          </div>
          <div class="account-info-item">
            <span class="account-info-item__label">{{ 'drawerAccount.labelAccountType' | translate }}</span>
            <span class="account-info-item__value">{{ getAccountType() }}</span>
          </div>
          <div class="account-info-item">
            <span class="account-info-item__label">{{ 'drawerAccount.labelRegistrationDate' | translate }}</span>
            <span class="account-info-item__value">{{ formatDate(user()?.createdAt) }}</span>
          </div>
          <div class="account-info-item">
            <span class="account-info-item__label">{{ 'drawerAccount.labelAccountStatus' | translate }}</span>
            <span class="account-info-item__value account-info-item__value--active">
              <span class="account-status-dot"></span>
              {{ 'drawerAccount.statusActive' | translate }}
            </span>
          </div>
        </div>
      </section>

      <!-- My Pets Section -->
      <section class="account-section">
        <h2 class="account-section__title">
          <span class="material-icons">pets</span>
          {{ 'drawerAccount.petsTitle' | translate }}
        </h2>

        @if (petsLoading()) {
          <div class="account-loading" style="min-height: 100px">
            <div class="account-loading__spinner"></div>
          </div>
        } @else if (activePets().length === 0) {
          <p class="account-section__desc">{{ 'drawerAccount.noPets' | translate }}</p>
        } @else {
          @for (pet of activePets(); track pet.id) {
            <div class="account-pet-card">
              <div class="account-pet-card__avatar">
                @if (pet.profilePhotoUrl) {
                  <img [src]="pet.profilePhotoUrl" [alt]="pet.name" />
                } @else {
                  <span class="material-icons">pets</span>
                }
              </div>
              <div class="account-pet-card__info">
                <span class="account-pet-card__name">{{ pet.name }}</span>
                <span class="account-pet-card__details">{{ pet.speciesName }} {{ pet.breedName ? '- ' + pet.breedName : '' }}</span>
              </div>
              <div class="account-pet-card__actions">
                <button type="button" class="account-action-btn account-action-btn--archive" (click)="confirmArchivePet(pet)" [attr.aria-label]="'drawerAccount.archivePet' | translate">
                  <span class="material-icons">archive</span>
                </button>
                <button type="button" class="account-action-btn account-action-btn--delete" (click)="confirmDeletePet(pet)" [attr.aria-label]="'drawerAccount.deletePetButton' | translate">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </div>
          }
        }

        <!-- Archived Pets Toggle -->
        @if (archivedPets().length > 0) {
          <button type="button" class="account-btn account-btn--ghost" style="margin-top: 12px" (click)="toggleArchivedPets()">
            <span class="material-icons">{{ showArchivedPets() ? 'expand_less' : 'expand_more' }}</span>
            {{ 'drawerAccount.archivedPetsTitle' | translate }} ({{ archivedPets().length }})
          </button>

          @if (showArchivedPets()) {
            @for (pet of archivedPets(); track pet.id) {
              <div class="account-pet-card account-pet-card--archived">
                <div class="account-pet-card__avatar account-pet-card__avatar--archived">
                  @if (pet.profilePhotoUrl) {
                    <img [src]="pet.profilePhotoUrl" [alt]="pet.name" />
                  } @else {
                    <span class="material-icons">pets</span>
                  }
                </div>
                <div class="account-pet-card__info">
                  <span class="account-pet-card__name">{{ pet.name }}</span>
                  <span class="account-pet-card__badge">{{ 'drawerAccount.archived' | translate }}</span>
                </div>
                <div class="account-pet-card__actions">
                  <button type="button" class="account-action-btn account-action-btn--restore" (click)="restorePet(pet)" [attr.aria-label]="'drawerAccount.restorePet' | translate">
                    <span class="material-icons">unarchive</span>
                  </button>
                </div>
              </div>
            }
          }
        }
      </section>

      <!-- Change Password Section -->
      @if (getAccountType() !== 'Google') {
        <section class="account-section">
          <h2 class="account-section__title">
            <span class="material-icons">lock</span>
            {{ 'drawerAccount.changePassword' | translate }}
          </h2>

          @if (!showChangePassword()) {
            <button type="button" class="account-btn account-btn--outline" (click)="toggleChangePassword()">
              <span class="material-icons">edit</span>
              {{ 'drawerAccount.changePassword' | translate }}
            </button>
          } @else {
            <div class="account-password-form">
              <div class="account-password-form__field">
                <label for="currentPassword">{{ 'drawerAccount.currentPassword' | translate }}</label>
                <input id="currentPassword" type="password" [value]="currentPassword()" (input)="currentPassword.set($any($event.target).value)" autocomplete="current-password" />
              </div>
              <div class="account-password-form__field">
                <label for="newPassword">{{ 'drawerAccount.newPassword' | translate }}</label>
                <input id="newPassword" type="password" [value]="newPassword()" (input)="newPassword.set($any($event.target).value)" autocomplete="new-password" />
              </div>
              <div class="account-password-form__field">
                <label for="confirmPassword">{{ 'drawerAccount.confirmPassword' | translate }}</label>
                <input id="confirmPassword" type="password" [value]="confirmPassword()" (input)="confirmPassword.set($any($event.target).value)" autocomplete="new-password" />
              </div>

              @if (passwordError()) {
                <div class="account-password-form__error">{{ passwordError() }}</div>
              }
              @if (passwordSuccess()) {
                <div class="account-password-form__success">{{ 'drawerAccount.passwordChanged' | translate }}</div>
              }

              <div class="account-password-form__actions">
                <button type="button" class="account-btn account-btn--ghost" (click)="toggleChangePassword()">
                  {{ 'drawerAccount.cancel' | translate }}
                </button>
                <button type="button" class="account-btn account-btn--primary" [disabled]="passwordChanging()" (click)="submitPasswordChange()">
                  {{ passwordChanging() ? ('drawerAccount.saving' | translate) : ('drawerAccount.save' | translate) }}
                </button>
              </div>
            </div>
          }
        </section>
      }

      <!-- Data Management Section -->
      <section class="account-section">
        <h2 class="account-section__title">
          <span class="material-icons">download</span>
          {{ 'drawerAccount.dataManagementTitle' | translate }}
        </h2>

        <p class="account-section__desc">
          {{ 'drawerAccount.dataManagementDesc' | translate }}
        </p>

        <button
          type="button"
          class="account-btn account-btn--outline"
          (click)="openExportModal()">
          <span class="material-icons">file_download</span>
          {{ 'drawerAccount.exportButton' | translate }}
        </button>
      </section>

      <!-- Danger Zone Section -->
      <section class="account-section account-section--danger">
        <h2 class="account-section__title account-section__title--danger">
          <span class="material-icons">warning</span>
          {{ 'drawerAccount.dangerZoneTitle' | translate }}
        </h2>

        <div class="account-danger-box">
          <div class="account-danger-info">
            <strong>{{ 'drawerAccount.deleteAccountLabel' | translate }}</strong>
            <p>{{ 'drawerAccount.deleteAccountDesc' | translate }}</p>
          </div>
          <button
            type="button"
            class="account-btn account-btn--danger"
            (click)="openDeleteConfirm()">
            {{ 'drawerAccount.deleteAccountButton' | translate }}
          </button>
        </div>
      </section>
    }
  </main>

</app-tab-page-shell-drawer>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm()) {
  <div class="modal-overlay" (click)="closeDeleteConfirm()">
    <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
      <div class="modal__header">
        <h3 class="modal__title">{{ 'drawerAccount.deleteConfirmTitle' | translate }}</h3>
        <button type="button" class="modal__close" (click)="closeDeleteConfirm()" [attr.aria-label]="'drawerAccount.closeAriaLabel' | translate">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal__body">
        <div class="modal__warning">
          <span class="material-icons">warning</span>
        </div>

        <p class="modal__text">{{ 'drawerAccount.deleteConfirmText' | translate }}</p>

        <div class="modal__confirm-input">
          <label for="deleteConfirmInput">
            {{ 'drawerAccount.deleteConfirmLabel' | translate }} <strong>elimina</strong>:
          </label>
          <input
            id="deleteConfirmInput"
            type="text"
            [value]="deleteConfirmText()"
            (input)="updateDeleteConfirmText($event)"
            placeholder="elimina"
            class="modal__input"
            autocomplete="off"
          >
        </div>

        @if (deleteError()) {
          <div class="modal__error">{{ deleteError() }}</div>
        }
      </div>

      <div class="modal__footer">
        <button type="button" class="account-btn account-btn--ghost" (click)="closeDeleteConfirm()">
          {{ 'drawerAccount.cancel' | translate }}
        </button>
        <button
          type="button"
          class="account-btn account-btn--danger"
          [disabled]="!canDelete || isDeleting()"
          (click)="confirmDelete()">
          {{ isDeleting() ? ('drawerAccount.deleting' | translate) : ('drawerAccount.delete' | translate) }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Export Data Modal -->
@if (showExportModal()) {
  <div class="modal-overlay" (click)="closeExportModal()">
    <div class="modal modal--small" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
      <div class="modal__header">
        <h3 class="modal__title">{{ 'drawerAccount.exportTitle' | translate }}</h3>
        <button type="button" class="modal__close" (click)="closeExportModal()" [attr.aria-label]="'drawerAccount.closeAriaLabel' | translate">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal__body">
        @if (!exportSuccess()) {
          <div class="modal__icon">
            <span class="material-icons">file_download</span>
          </div>
          <p class="modal__text">{{ 'drawerAccount.exportDesc' | translate }}</p>
        } @else {
          <div class="modal__success">
            <span class="material-icons">check_circle</span>
          </div>
          <p class="modal__text modal__text--success">{{ 'drawerAccount.exportSuccess' | translate }}</p>
        }
      </div>

      <div class="modal__footer">
        @if (!exportSuccess()) {
          <button type="button" class="account-btn account-btn--ghost" (click)="closeExportModal()">
            {{ 'drawerAccount.cancel' | translate }}
          </button>
          <button
            type="button"
            class="account-btn account-btn--primary"
            [disabled]="isExporting()"
            (click)="exportData()">
            {{ isExporting() ? ('drawerAccount.exporting' | translate) : ('drawerAccount.export' | translate) }}
          </button>
        } @else {
          <button type="button" class="account-btn account-btn--primary" (click)="closeExportModal()">
            {{ 'drawerAccount.close' | translate }}
          </button>
        }
      </div>
    </div>
  </div>
}
