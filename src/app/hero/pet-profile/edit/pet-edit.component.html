<app-tab-page-shell-blue
  title="Modifica Profilo"
  activeTabId="pet-profile"
  [showBack]="true"
  (backClicked)="goBack()">

  <!-- Main scrollable content -->
  <div class="pet-edit">

    @if (isLoading()) {
      <div class="pet-edit__loading">
        <span class="pet-edit__spinner"></span>
        <p>Caricamento...</p>
      </div>
    }

    @if (errorMessage() && !isLoading()) {
      <div class="pet-edit__error">
        <p>{{ errorMessage() }}</p>
        <button class="pet-edit__save-btn" (click)="goBack()">Torna indietro</button>
      </div>
    }

    @if (!isLoading() && !errorMessage()) {
    <!-- Section: Profile Photo -->
    <section class="pet-edit__photo-section" aria-label="Foto profilo">
      <div class="pet-edit__avatar-wrapper">
        <img
          [src]="profilePhoto()"
          alt="Foto profilo del pet"
          class="pet-edit__avatar"
        />
        <button
          class="pet-edit__avatar-overlay"
          (click)="onChangeProfilePhoto()"
          aria-label="Cambia foto profilo"
          type="button"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12m-3.2 0a3.2 3.2 0 1 0 6.4 0a3.2 3.2 0 1 0 -6.4 0"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
      </div>
      <p class="pet-edit__photo-hint">Tocca per cambiare foto</p>
    </section>

    <!-- Section: Cover Photos (tap to set as profile) -->
    <section class="pet-edit__cover-section" aria-label="Galleria foto">
      <label class="pet-edit__label">FOTO â€” tocca per impostare come profilo</label>
      <div class="pet-edit__cover-scroll">
        @for (photo of galleryPhotos(); track photo.id; let i = $index) {
          @if (i < 6) {
            <button
              class="pet-edit__cover-thumb"
              [class.pet-edit__cover-thumb--selected]="photo.isProfilePhoto"
              (click)="onSetAsProfilePhoto(photo)"
              [attr.aria-label]="photo.isProfilePhoto ? 'Foto profilo attuale' : 'Imposta come foto profilo'"
              type="button"
            >
              <img [src]="photo.thumbnailUrl || photo.url" [alt]="'Foto ' + (i + 1)" />
              @if (photo.isProfilePhoto) {
                <span class="pet-edit__cover-check">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                </span>
              }
            </button>
          }
        }
        <button
          class="pet-edit__cover-add"
          (click)="onAddCoverPhoto()"
          aria-label="Aggiungi foto"
          type="button"
        >
          <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
        </button>
      </div>
    </section>

    <!-- Section: Form Fields -->
    <section class="pet-edit__form" aria-label="Dati del pet">

      <!-- Nome -->
      <div class="pet-edit__field">
        <label class="pet-edit__label" for="pet-name">NOME</label>
        <input
          id="pet-name"
          type="text"
          class="pet-edit__input"
          [ngModel]="form().name"
          (ngModelChange)="updateField('name', $event)"
          placeholder="Nome del pet"
          autocomplete="off"
        />
      </div>

      <!-- Razza (readonly) -->
      <div class="pet-edit__field">
        <label class="pet-edit__label" for="pet-breed">RAZZA</label>
        <input
          id="pet-breed"
          type="text"
          class="pet-edit__input pet-edit__input--disabled"
          [ngModel]="form().breed"
          readonly
          tabindex="-1"
        />
      </div>

      <!-- Sesso -->
      <div class="pet-edit__field">
        <label class="pet-edit__label" for="pet-sex">SESSO</label>
        <select
          id="pet-sex"
          class="pet-edit__input pet-edit__select"
          [ngModel]="form().sex"
          (ngModelChange)="updateField('sex', $event)"
        >
          @for (option of sexOptions; track option) {
            <option [value]="option">{{ option }}</option>
          }
        </select>
      </div>

      <!-- Data di nascita -->
      <div class="pet-edit__field">
        <label class="pet-edit__label" for="pet-birthdate">DATA DI NASCITA</label>
        <input
          id="pet-birthdate"
          type="date"
          class="pet-edit__input"
          [ngModel]="form().birthDate"
          (ngModelChange)="updateField('birthDate', $event)"
        />
      </div>

      <!-- Peso -->
      <div class="pet-edit__field">
        <label class="pet-edit__label" for="pet-weight">PESO</label>
        <div class="pet-edit__input-group">
          <input
            id="pet-weight"
            type="number"
            class="pet-edit__input pet-edit__input--weight"
            [ngModel]="form().weight"
            (ngModelChange)="updateField('weight', $event)"
            placeholder="0"
            min="0"
            max="200"
            step="0.1"
          />
          <span class="pet-edit__input-suffix">kg</span>
        </div>
      </div>

      <!-- Bio / Descrizione -->
      <div class="pet-edit__field">
        <label class="pet-edit__label" for="pet-bio">DESCRIZIONE</label>
        <textarea
          id="pet-bio"
          class="pet-edit__input pet-edit__textarea"
          [ngModel]="form().bio"
          (ngModelChange)="updateField('bio', $event)"
          placeholder="Racconta qualcosa sul tuo pet..."
          rows="4"
          maxlength="300"
        ></textarea>
        <span class="pet-edit__char-count">
          {{ form().bio.length }} / 300
        </span>
      </div>
    </section>


    <!-- Save Button -->
    <div class="pet-edit__actions">
      <button
        class="pet-edit__save-btn"
        (click)="onSave()"
        [disabled]="isSaving()"
        type="button"
      >
        @if (isSaving()) {
          <span class="pet-edit__spinner"></span>
          Salvataggio...
        } @else {
          Salva Modifiche
        }
      </button>
    </div>

    <!-- Delete Profile -->
    <div class="pet-edit__danger-zone">
      <button
        class="pet-edit__delete-btn"
        (click)="onDeleteProfile()"
        type="button"
      >
        Elimina Profilo
      </button>
    </div>
    } <!-- end @if (!isLoading() && !errorMessage()) -->

  </div>

  <!-- Upload progress overlay -->
  @if (isUploadingPhoto()) {
    <div class="upload-overlay">
      <div class="upload-overlay__content">
        <span class="pet-edit__spinner"></span>
        <p>Caricamento foto... {{ uploadProgress() }}%</p>
      </div>
    </div>
  }

  <!-- Photo Upload Modal -->
  @if (showPhotoUpload()) {
    <app-photo-upload-modal
      [aspectRatio]="photoUploadMode() === 'profile' ? 1 : 4/3"
      [maxSize]="800"
      [title]="photoUploadMode() === 'profile' ? 'Foto profilo' : 'Aggiungi foto'"
      (confirmed)="onPhotoConfirmed($event)"
      (cancelled)="onPhotoCancelled()">
    </app-photo-upload-modal>
  }

  <!-- Slide-to-Delete Confirmation Modal -->
  @if (showDeleteModal()) {
    <div class="delete-confirm__backdrop" (click)="cancelDelete()">
      <div class="delete-confirm__modal" (click)="$event.stopPropagation()">

        <!-- Warning icon -->
        <div class="delete-confirm__icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
        </div>

        <h3 class="delete-confirm__title">Eliminare {{ form().name }}?</h3>
        <p class="delete-confirm__message">
          Questa azione non puo essere annullata. Tutti i dati, le foto e i ricordi di {{ form().name }} verranno eliminati definitivamente.
        </p>

        <!-- Slide track -->
        <div class="delete-confirm__track"
          (pointerdown)="onSlideStart($event)"
          (pointermove)="onSlideMove($event)"
          (pointerup)="onSlideEnd()"
          (pointerleave)="onSlideEnd()"
          (touchstart)="onSlideStart($event)"
          (touchmove)="onSlideMove($event)"
          (touchend)="onSlideEnd()">

          <!-- Fill bar -->
          <div class="delete-confirm__fill"
            [style.width.%]="slideProgress() * 100">
          </div>

          <!-- Label -->
          <span class="delete-confirm__label"
            [style.opacity]="1 - slideProgress()">
            Scorri per eliminare
          </span>

          <!-- Handle -->
          <div class="delete-confirm__handle"
            [style.left.%]="slideProgress() * (100 - 18)"
            [class.delete-confirm__handle--ready]="slideProgress() >= 0.9">
            @if (isDeleting()) {
              <span class="pet-edit__spinner"></span>
            } @else {
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
            }
          </div>
        </div>

        <!-- Cancel -->
        <button class="delete-confirm__cancel" (click)="cancelDelete()" type="button">
          Annulla
        </button>
      </div>
    </div>
  }

</app-tab-page-shell-blue>
