<app-tab-page-shell-pet-profile
  title="Profilo"
  activeTabId="pet-profile"
  [showBack]="true"
  (backClicked)="goBack()">

  <!-- Pet Photo Slot: vai dentro il cerchio bianco -->
  <ng-container shellPetPhoto>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <img
        [src]="pet.photoUrl"
        [alt]="pet.name"
        class="pet-profile__photo"
      />
    }
  </ng-container>

  <!-- Quick Actions: 5 icone blu colonna destra -->
  <ng-container shellQuickActions>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <app-profile-icon icon="calendar" variant="circular" ariaLabel="Calendario" (onClick)="onCalendarClick()" />
      <app-profile-icon icon="notifications" variant="circular" ariaLabel="Notifiche" (onClick)="onNotificationsClick()" />
      <app-profile-icon icon="edit" variant="circular" ariaLabel="Modifica pet" (onClick)="onEditPetClick()" />
      <app-profile-icon icon="messages" variant="circular" ariaLabel="Messaggi" (onClick)="onMessagesClick()" />
      <app-profile-icon icon="bookmark" variant="circular" ariaLabel="Salvati" (onClick)="onSavedClick()" />
    }
  </ng-container>

  <!-- Left Actions: FAB + dots a sinistra -->
  <ng-container shellLeftActions>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <button
        class="pet-profile__add-pet"
        (click)="onAddPetClick()"
        aria-label="Aggiungi nuovo pet"
      >
        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
      </button>
      <div class="pet-profile__dots">
        <span class="pet-profile__dot pet-profile__dot--active"></span>
        <span class="pet-profile__dot"></span>
        <span class="pet-profile__dot"></span>
      </div>
    }
  </ng-container>

  <!-- Sticky Content Slot: speech bubble resta nell'area gialla -->
  <ng-container shellStickyContent>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <div class="pet-profile__bubble">
        <app-speech-bubble tailPosition="left" variant="ai">
          Andiamo a Fiutare il mondo?
        </app-speech-bubble>
      </div>
    }
  </ng-container>

  <!-- Main Content: scrollabile dentro la card blu -->
  <div class="pet-profile__content">
    <!-- Loading state -->
    @if (isLoading()) {
      <div class="pet-profile__loading">
        <div class="pet-profile__spinner"></div>
        <p>Caricamento dati pet...</p>
      </div>
    }

    <!-- Error state -->
    @if (errorMessage() && !isLoading()) {
      <div class="pet-profile__error">
        <p>{{ errorMessage() }}</p>
        <button class="pet-profile__retry-btn" routerLink="/home/pet-register/specie">
          Registra un pet
        </button>
      </div>
    }

    @if (!isLoading() && !errorMessage() && pet.id) {
      <!-- Nome + descrizione SPOSTATI dentro card blu -->
      <section class="pet-profile__header-info">
        <h1 class="pet-profile__name">{{ pet.name }}</h1>
        <p class="pet-profile__description">{{ pet.description }}</p>
      </section>

      <!-- Pet info card: 5 items -->
      <section class="pet-profile__info">
        <app-pet-info-card [items]="petInfoItems"></app-pet-info-card>
      </section>

      <!-- CTA: 3 icon buttons + card promo affiancata -->
      <section class="pet-profile__actions">
        <div class="pet-profile__cta-row">
          <app-profile-icon icon="foto" variant="cta" ariaLabel="Banda Pelosa" (onClick)="onBandaPelosaClick()" />
          <app-profile-icon icon="doc" variant="cta" ariaLabel="Fatti Bestiali" (onClick)="onFattiBestialiClick()" />
          <app-profile-icon icon="friends" variant="cta" ariaLabel="Rullino Feroce" (onClick)="onRullinoFeroceClick()" />
        </div>
        <button class="pet-profile__promo-card-inline" (click)="onAppCompletaClick()">
          <span class="pet-profile__promo-card-inline-title">Vuoi sapere come sta il tuo pet?</span>
          <span class="pet-profile__promo-card-inline-subtitle">Prova la App Completa</span>
          <span class="pet-profile__promo-card-inline-dots">
            <span class="pet-profile__promo-card-dot pet-profile__promo-card-dot--active"></span>
            <span class="pet-profile__promo-card-dot"></span>
            <span class="pet-profile__promo-card-dot"></span>
          </span>
        </button>
      </section>

      <!-- Testo intro mappa + Mini map -->
      <section class="pet-profile__map">
        <p class="pet-profile__map-intro">Testa e prova la mappa interattiva</p>
        <div class="pet-profile__map-container">
          <div class="pet-profile__map-placeholder">
            <span>Mappa</span>
          </div>
          <button class="pet-profile__fiuta-btn" (click)="onFiutaClick()">
            FIUTA
          </button>
        </div>
      </section>

      <!-- Promo slider -->
      <section class="pet-profile__promo">
        <div class="pet-profile__promo-slides">
          @for (slide of promoSlides; track slide.id; let i = $index) {
            <div
              class="pet-profile__promo-slide"
              [class.pet-profile__promo-slide--active]="i === currentSlide"
            >
              <h3>{{ slide.title }}</h3>
              <p>{{ slide.description }}</p>
            </div>
          }
        </div>
        <div class="pet-profile__promo-dots">
          @for (slide of promoSlides; track slide.id; let i = $index) {
            <button
              class="pet-profile__promo-dot"
              [class.pet-profile__promo-dot--active]="i === currentSlide"
              (click)="goToSlide(i)"
              [attr.aria-label]="'Vai a slide ' + (i + 1)"
            ></button>
          }
        </div>
      </section>

      <!-- Online friends -->
      <section class="pet-profile__friends">
        <h3 class="pet-profile__friends-title">Amici Online</h3>
        <div class="pet-profile__friends-scroll">
          @for (friend of onlineFriends; track friend.id) {
            <button
              class="pet-profile__friend-card"
              (click)="onFriendClick(friend)"
            >
              <img
                [src]="friend.avatarUrl"
                [alt]="friend.name"
                class="pet-profile__friend-avatar"
              />
              <span class="pet-profile__friend-name">{{ friend.name }}</span>
              @if (friend.online) {
                <span class="pet-profile__friend-online"></span>
              }
            </button>
          }
        </div>
      </section>
    }
  </div>

  <!-- Mascot Bottom Sheet -->
  <app-mascot-bottom-sheet
    [isOpen]="showMascotSheet()"
    [hideMascot]="true"
    [aiMessage]="'Ciao! Come posso aiutarti?'"
    (closed)="closeMascotSheet()">
  </app-mascot-bottom-sheet>

</app-tab-page-shell-pet-profile>
