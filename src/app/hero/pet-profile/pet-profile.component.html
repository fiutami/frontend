<app-tab-page-shell-pet-profile
  title="Profilo"
  activeTabId="pet-profile"
  [showBack]="true"
  (backClicked)="goBack()">

  <!-- Pet Photo Slot: vai dentro il cerchio bianco -->
  <ng-container shellPetPhoto>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <div class="pet-profile__photo-wrapper">
        <img
          [src]="pet.photoUrl"
          [alt]="pet.name"
          class="pet-profile__photo"
        />
        @if (isUploadingPhoto()) {
          <div class="pet-profile__photo-uploading">
            <div class="pet-profile__photo-progress">
              <svg viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                <circle cx="18" cy="18" r="16" fill="none" stroke="white" stroke-width="3"
                  stroke-dasharray="100.53" [attr.stroke-dashoffset]="100.53 - (100.53 * uploadProgress() / 100)"
                  stroke-linecap="round" transform="rotate(-90 18 18)"/>
              </svg>
            </div>
          </div>
        }
        <button
          class="pet-profile__photo-edit"
          (click)="onEditPhotoClick(); $event.stopPropagation()"
          aria-label="Cambia foto profilo"
          [disabled]="isUploadingPhoto()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12m-3.2 0a3.2 3.2 0 1 0 6.4 0a3.2 3.2 0 1 0 -6.4 0"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
        @if (showPhotoMenu()) {
          <div class="pet-profile__photo-menu" (click)="$event.stopPropagation()">
            <button class="pet-profile__photo-menu-item" (click)="onChangePhoto()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
              </svg>
              <span>Cambia foto</span>
            </button>
            <button class="pet-profile__photo-menu-item pet-profile__photo-menu-item--danger" (click)="deleteProfilePhoto()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
              <span>Elimina foto</span>
            </button>
          </div>
        }
      </div>
    }
  </ng-container>

  <!-- Quick Actions: 5 icone blu colonna destra -->
  <ng-container shellQuickActions>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <app-profile-icon icon="calendar" variant="circular" ariaLabel="Calendario" (onClick)="onCalendarClick()" />
      <app-profile-icon icon="notifications" variant="circular" ariaLabel="Notifiche" (onClick)="onNotificationsClick()" />
      <app-profile-icon icon="edit" variant="circular" ariaLabel="Modifica pet" (onClick)="onEditPetClick()" />
      <app-profile-icon icon="messages" variant="circular" ariaLabel="Messaggi" (onClick)="onMessagesClick()" />
      <app-profile-icon icon="bookmark" variant="circular" ariaLabel="Salvati" (onClick)="onSavedClick()" />
    }
  </ng-container>

  <!-- Left Actions: FAB + dots a sinistra -->
  <ng-container shellLeftActions>
    @if (!isLoading() && !errorMessage() && pet.id) {
      <button
        class="pet-profile__add-pet"
        (click)="onAddPetClick()"
        aria-label="Aggiungi nuovo pet"
      >
        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
      </button>
      <div class="pet-profile__dots">
        @for (p of allPets(); track p.id; let i = $index) {
          <button
            class="pet-profile__dot"
            [class.pet-profile__dot--active]="i === currentPetIndex()"
            (click)="goToPet(i)"
            [attr.aria-label]="'Vai a ' + p.name"
          ></button>
        }
      </div>
    }
  </ng-container>

  <!-- Sticky Content Slot -->
  <ng-container shellStickyContent>
  </ng-container>

  <!-- Main Content: scrollabile dentro la card blu -->
  <div class="pet-profile__content"
    (pointerdown)="onSwipeStart($event)"
    (pointerup)="onSwipeEnd($event)">
    <!-- Loading state -->
    @if (isLoading()) {
      <div class="pet-profile__loading">
        <div class="pet-profile__spinner"></div>
        <p>Caricamento dati pet...</p>
      </div>
    }

    <!-- Error state -->
    @if (errorMessage() && !isLoading()) {
      <div class="pet-profile__error">
        <p>{{ errorMessage() }}</p>
        <button class="pet-profile__retry-btn" routerLink="/home/pet-register/specie">
          Registra un pet
        </button>
      </div>
    }

    @if (!isLoading() && !errorMessage() && pet.id) {
      <!-- Nome + descrizione SPOSTATI dentro card blu -->
      <section class="pet-profile__header-info">
        <h1 class="pet-profile__name">{{ pet.name }}</h1>
        <p class="pet-profile__description">{{ pet.description }}</p>
      </section>

      <!-- Pet info card: 5 items -->
      <section class="pet-profile__info">
        <app-pet-info-card [items]="petInfoItems"></app-pet-info-card>
      </section>

      <!-- CTA: 3 icon buttons + card promo affiancata -->
      <section class="pet-profile__actions">
        <div class="pet-profile__cta-row">
          <app-profile-icon icon="friends" variant="cta" ariaLabel="Banda Pelosa" (onClick)="onBandaPelosaClick()" />
          <app-profile-icon icon="doc" variant="cta" ariaLabel="Fatti Bestiali" (onClick)="onFattiBestialiClick()" />
          <app-profile-icon icon="foto" variant="cta" ariaLabel="Rullino Feroce" (onClick)="onRullinoFeroceClick()" />
        </div>
      </section>

      <!-- Testo intro mappa + Mini map -->
      <section class="pet-profile__map">
        <p class="pet-profile__map-intro">Testa e prova la mappa interattiva</p>
        <div class="pet-profile__map-container">
          <div #miniMapEl class="pet-profile__minimap"></div>
          <button class="pet-profile__fiuta-btn" (click)="onFiutaClick()">
            FIUTA
          </button>
        </div>
      </section>

      <!-- Partner in evidenza -->
      <section class="pet-profile__partners">
        <h3 class="pet-profile__partners-title">Partner in evidenza</h3>
        <div class="pet-profile__partners-scroll">
          @for (partner of partnerShowcase(); track partner.id) {
            <button class="pet-profile__partner-card" [style.--partner-color]="partnerColors[partner.type]">
              <div class="pet-profile__partner-icon">
                <span>{{ partnerIcons[partner.type] }}</span>
              </div>
              <div class="pet-profile__partner-info">
                <span class="pet-profile__partner-name">{{ partner.name }}</span>
                <span class="pet-profile__partner-location">{{ partner.location }}</span>
              </div>
              <div class="pet-profile__partner-badge" [class]="'pet-profile__partner-badge--' + partner.tier">
                @if (partner.tier === 'premium') {
                  Premium
                } @else if (partner.tier === 'base') {
                  Sponsor
                } @else {
                  Free
                }
              </div>
              @if (partner.rating) {
                <div class="pet-profile__partner-rating">
                  <span class="material-icons">star</span>
                  <span>{{ partner.rating }}</span>
                </div>
              }
            </button>
          }
        </div>
      </section>

      <!-- Promo slider -->
      <section class="pet-profile__promo">
        <div class="pet-profile__promo-slides">
          @for (slide of promoSlides; track slide.id; let i = $index) {
            <div
              class="pet-profile__promo-slide"
              [class.pet-profile__promo-slide--active]="i === currentSlide"
            >
              <h3>{{ slide.title }}</h3>
              <p>{{ slide.description }}</p>
            </div>
          }
        </div>
        <div class="pet-profile__promo-dots">
          @for (slide of promoSlides; track slide.id; let i = $index) {
            <button
              class="pet-profile__promo-dot"
              [class.pet-profile__promo-dot--active]="i === currentSlide"
              (click)="goToSlide(i)"
              [attr.aria-label]="'Vai a slide ' + (i + 1)"
            ></button>
          }
        </div>
      </section>
    }
  </div>

  <!-- Mascot Bottom Sheet -->
  <app-mascot-bottom-sheet
    [isOpen]="showMascotSheet()"
    [hideMascot]="true"
    [aiMessage]="'Ciao! Come posso aiutarti?'"
    (closed)="closeMascotSheet()">
  </app-mascot-bottom-sheet>

  <!-- Photo Upload Modal -->
  @if (showPhotoUpload()) {
    <app-photo-upload-modal
      [aspectRatio]="1"
      [maxSize]="600"
      title="Foto profilo"
      (confirmed)="onPhotoConfirmed($event)"
      (cancelled)="onPhotoCancelled()">
    </app-photo-upload-modal>
  }

  <!-- Paywall Modal -->
  @if (showPaywall()) {
    <div class="pet-profile__paywall-overlay" (click)="closePaywall()">
      <div class="pet-profile__paywall" (click)="$event.stopPropagation()">
        <button class="pet-profile__paywall-close" (click)="closePaywall()" aria-label="Chiudi">
          <span class="material-icons">close</span>
        </button>
        <span class="material-icons pet-profile__paywall-icon">pets</span>
        <h3 class="pet-profile__paywall-title">Limite raggiunto</h3>
        <p class="pet-profile__paywall-text">Hai raggiunto il numero massimo di pet per il tuo piano. Passa a <strong>Premium</strong> per aggiungerne altri!</p>
        <button class="pet-profile__paywall-btn" (click)="goToPremium()">
          Passa a Premium
        </button>
      </div>
    </div>
  }

</app-tab-page-shell-pet-profile>
