<div class="chat-screen">
  <!-- Header with blue background -->
  <header class="chat-screen__header">
    <div class="chat-screen__header-bg">
      <button
        class="chat-screen__back-btn"
        (click)="goBack()"
        aria-label="Torna alla lista"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>

      <div class="chat-screen__header-info">
        <div class="chat-screen__avatar">
          @if (recipientAvatar()) {
            <img [src]="recipientAvatar()" [alt]="conversationName()" class="chat-screen__avatar-img" />
          } @else {
            {{ conversationName().charAt(0).toUpperCase() }}
          }
          @if (isOnline()) {
            <span class="chat-screen__online-dot"></span>
          }
        </div>
        <div class="chat-screen__name-info">
          <span class="chat-screen__name">{{ conversationName() }}</span>
          <span class="chat-screen__status">
            @if (isOnline()) {
              <span class="chat-screen__status-dot"></span>
              On line
            } @else {
              Offline
            }
          </span>
        </div>
      </div>

      <div class="chat-screen__header-actions">
        <button class="chat-screen__action-btn" aria-label="Chiama">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
          </svg>
        </button>
        <button class="chat-screen__action-btn" aria-label="Altre opzioni">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="chat-screen__header-separator"></div>
  </header>

  <!-- Messages Container -->
  <main class="chat-screen__messages" #messagesContainer>
    <div class="chat-screen__messages-inner">
      <!-- Date separator -->
      @if (messages().length > 0) {
        <div class="chat-screen__date-separator">
          <span>{{ getDateLabel() }}</span>
        </div>
      }

      @for (message of messages(); track message.id) {
        <div
          class="chat-screen__message"
          [class.chat-screen__message--sent]="message.sent"
          [class.chat-screen__message--received]="!message.sent"
        >
          @if (!message.sent) {
            <div class="chat-screen__message-avatar">
              @if (recipientAvatar()) {
                <img [src]="recipientAvatar()" [alt]="conversationName()" />
              } @else {
                {{ conversationName().charAt(0).toUpperCase() }}
              }
              @if (isOnline()) {
                <span class="chat-screen__avatar-dot"></span>
              }
            </div>
          }
          <div class="chat-screen__bubble">
            @if (message.attachmentUrl) {
              <img [src]="message.attachmentUrl" class="chat-screen__attachment" alt="Allegato" />
            }
            <p class="chat-screen__text">{{ message.text }}</p>
            <span class="chat-screen__time">{{ message.time }}</span>
          </div>
        </div>
      }
    </div>

    <!-- Typing indicator -->
    @if (isTyping()) {
      <div class="chat-screen__typing">
        sta scrivendo...
      </div>
    }
  </main>

  <!-- Input Area -->
  <footer class="chat-screen__input-area">
    <div class="chat-screen__input-wrapper">
      <input
        type="text"
        class="chat-screen__input"
        placeholder="Scrivi messaggio"
        [value]="messageInput()"
        (input)="messageInput.set($any($event.target).value)"
        (keypress)="onInputKeyPress($event)"
        aria-label="Scrivi un messaggio"
      />

      <div class="chat-screen__input-actions">
        <button
          class="chat-screen__input-btn"
          aria-label="Allega file"
        >
          <svg width="19" height="18" viewBox="0 0 19 18" fill="currentColor">
            <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
          </svg>
        </button>
        <button
          class="chat-screen__input-btn"
          aria-label="Scatta foto"
        >
          <svg width="19" height="19" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="3.2"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
        <button
          class="chat-screen__send-btn"
          (click)="sendMessage()"
          [disabled]="!messageInput().trim()"
          aria-label="Invia messaggio"
        >
          <svg width="21" height="21" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-4h2v2h-2zm0-2h2l.5-6h-3l.5 6z"/>
            <path d="M8 12l4 4 4-4"/>
          </svg>
        </button>
      </div>
    </div>
  </footer>
</div>
