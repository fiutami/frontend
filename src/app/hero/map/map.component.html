<!-- Usa TabPageShellDefault: Avatar, Logo, MascotPeek, TabBar sono automatici -->
<app-tab-page-shell-default
  title="Mappa"
  activeTabId="map"
  [showBack]="true"
  (backClicked)="goBack()">

  <!-- Extra sotto il logo (dentro blu): Subtitle -->
  <div shellBrandingExtra class="map-subtitle">
    <span class="map-subtitle__line1">{{ 'map.subtitle' | translate }}</span>
    <span class="map-subtitle__line2">{{ 'map.description' | translate }}</span>
  </div>

  <!-- Sticky Content (su giallo): Search + Actions + Filters -->
  <ng-container shellStickyContent>
    <!-- Search bar -->
    <div class="search-container">
      <div class="search-box">
        <span class="material-icons search-icon">search</span>
        <input
          type="text"
          class="search-input"
          [placeholder]="'map.searchPlaceholder' | translate"
          [value]="searchQuery()"
          (input)="onSearch($event)"
        >
        <button class="filter-button" [attr.aria-label]="'map.filters' | translate">
          <span class="material-icons">tune</span>
        </button>
      </div>
    </div>

  </ng-container>

  <!-- Backdrop overlay quando mappa espansa -->
  @if (isMapExpanded()) {
    <div class="map-overlay-backdrop" (click)="closeMapOverlay()"></div>
  }

  <!-- Main Content: Map + Section + Promo -->
  <!-- Map container -->
  <div class="map-container" [class.map-container--expanded]="isMapExpanded()">
    <div id="map" class="map"></div>

    <!-- Expand/Fullscreen button -->
    <button
      class="map-expand-btn"
      (click)="toggleMapExpand()"
      [attr.aria-label]="isMapExpanded() ? ('map.closeMap' | translate) : ('map.expandMap' | translate)">
      <span class="material-icons">
        {{ isMapExpanded() ? 'close' : 'fullscreen' }}
      </span>
    </button>

    <!-- Location button -->
    <button
      class="location-button"
      [class.location-button--active]="isLocationEnabled()"
      (click)="centerOnUser()"
      [attr.aria-label]="'map.myLocation' | translate">
      <span class="material-icons">my_location</span>
    </button>

    <!-- Current location indicator -->
    <div class="current-location">
      <div class="current-location__icon">
        <span class="material-icons">place</span>
      </div>
      <div class="current-location__info">
        <span class="current-location__label">{{ 'map.currentLocation' | translate }}</span>
        <span class="current-location__name">{{ currentLocationName() }}</span>
      </div>
    </div>
  </div>

  <!-- Section title: Partner in evidenza -->
  <div class="section-title">
    <h2>{{ 'map.partnerShowcase.title' | translate }}</h2>
  </div>

  <!-- Partner showcase cards (vetrina dinamica) -->
  <div class="partner-showcase">
    @for (partner of partnerShowcase(); track partner.id) {
      <button class="partner-card" [style.--partner-color]="partnerColors[partner.type]">
        <!-- Logo/Icon -->
        <div class="partner-card__icon">
          <span>{{ partnerIcons[partner.type] }}</span>
        </div>

        <!-- Info -->
        <div class="partner-card__info">
          <span class="partner-card__name">{{ partner.name }}</span>
          <span class="partner-card__location">{{ partner.location }}</span>
        </div>

        <!-- Badge tier -->
        <div class="partner-card__badge" [class]="'partner-card__badge--' + partner.tier">
          @if (partner.tier === 'premium') {
            ‚≠ê {{ 'map.partnerShowcase.premium' | translate }}
          } @else if (partner.tier === 'base') {
            {{ 'map.partnerShowcase.sponsor' | translate }}
          } @else {
            {{ 'map.partnerShowcase.free' | translate }}
          }
        </div>

        <!-- Rating (se presente) -->
        @if (partner.rating) {
          <div class="partner-card__rating">
            <span class="material-icons">star</span>
            <span>{{ partner.rating }}</span>
          </div>
        }
      </button>
    }
  </div>

  <!-- Promo banner FIUTAMI Plus -->
  <div class="promo-banner" (click)="goToPremium()">
    <div class="promo-banner__content">
      <p class="promo-banner__text">{{ 'map.promo.text' | translate }}</p>
      <button class="promo-banner__button">{{ 'map.promo.button' | translate }}</button>
    </div>
    <div class="promo-banner__indicator">
      <span class="dot active"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  </div>

  <!-- POI Card (bottom sheet overlay) -->
  @if (selectedPOI(); as poi) {
    <div class="poi-card" [class.poi-card--expanded]="isMapExpanded()" (click)="$event.stopPropagation()">
      <button class="poi-card__close" (click)="closePOICard()">
        <span class="material-icons">close</span>
      </button>

      <div class="poi-card__header">
        <div class="poi-card__type-badge" [style.background-color]="markerColors[poi.type]">
          {{ poi.type | titlecase }}
        </div>
        <h3 class="poi-card__name">{{ poi.name }}</h3>
        <p class="poi-card__address">{{ poi.address }}</p>
      </div>

      <div class="poi-card__details">
        @if (poi.rating) {
          <div class="poi-card__rating">
            <span class="material-icons star">star</span>
            <span class="rating-value">{{ formatRating(poi.rating) }}</span>
            @if (poi.reviewCount) {
              <span class="review-count">({{ poi.reviewCount }})</span>
            }
          </div>
        }
        @if (poi.distance) {
          <div class="poi-card__distance">
            <span class="material-icons">place</span>
            <span>{{ formatDistance(poi.distance) }}</span>
          </div>
        }
      </div>

      <div class="poi-card__actions">
        <button class="poi-action-btn poi-action-btn--directions" (click)="openDirections(poi)">
          <span class="material-icons">directions</span>
          <span>{{ 'map.poi.directions' | translate }}</span>
        </button>
        <button
          class="poi-action-btn poi-action-btn--save"
          [class.poi-action-btn--saved]="poi.isFavorite"
          (click)="toggleFavorite(poi)">
          <span class="material-icons">{{ poi.isFavorite ? 'bookmark' : 'bookmark_border' }}</span>
          <span>{{ poi.isFavorite ? ('map.poi.saved' | translate) : ('map.poi.save' | translate) }}</span>
        </button>
      </div>
    </div>
  }

  <!-- Mascot Bottom Sheet (mantenuto per AI chat) -->
  <app-mascot-bottom-sheet
    [isOpen]="showMascotSheet()"
    [hideMascot]="true"
    [aiMessage]="mascotMessage()"
    (closed)="closeMascotSheet()">
  </app-mascot-bottom-sheet>

</app-tab-page-shell-default>
