<!-- Usa TabPageShellDefault: Avatar, Logo, MascotPeek, TabBar sono automatici -->
<app-tab-page-shell-default
  title="Mappa"
  activeTabId="map"
  [showBack]="true"
  (backClicked)="goBack()">

  <!-- Extra sotto il logo (dentro blu): Subtitle -->
  <p shellBrandingExtra class="map-subtitle">
    Attività, eventi e amici<br>
    Trova ciò che serve al tuo pet, proprio dove sei
  </p>

  <!-- Sticky Content (su giallo): Search + Actions + Filters -->
  <ng-container shellStickyContent>
    <!-- Search bar -->
    <div class="search-container">
      <div class="search-box">
        <span class="material-icons search-icon">search</span>
        <input
          type="text"
          class="search-input"
          placeholder="Cosa stai cercando"
          [value]="searchQuery()"
          (input)="onSearch($event)"
        >
        <button class="filter-button" aria-label="Filtri">
          <span class="material-icons">tune</span>
        </button>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="action-buttons">
      <button class="action-btn action-btn--primary">Attività</button>
      <button class="action-btn action-btn--primary">Eventi</button>
      <button class="action-btn action-btn--primary">Localizzati dagli amici</button>
    </div>

    <!-- Filter chips -->
    <div class="filter-chips">
      @for (filter of filters(); track filter.type) {
        <button
          class="filter-chip"
          [class.filter-chip--active]="filter.active"
          [style.--chip-color]="filter.color"
          (click)="toggleFilter(filter)">
          <span class="filter-chip__text">{{ filter.label }}</span>
        </button>
      }
    </div>

    <!-- Location toggle -->
    <div class="location-toggle">
      <span class="location-toggle__label">Attiva location</span>
      <button
        class="toggle-switch"
        [class.toggle-switch--active]="isLocationEnabled()"
        (click)="centerOnUser()"
        role="switch"
        [attr.aria-checked]="isLocationEnabled()">
        <span class="toggle-switch__slider"></span>
      </button>
    </div>
  </ng-container>

  <!-- Main Content: Map + Section + Promo -->
  <!-- Map container -->
  <div class="map-container">
    <div id="map" class="map"></div>

    <!-- Location button -->
    <button
      class="location-button"
      [class.location-button--active]="isLocationEnabled()"
      (click)="centerOnUser()"
      aria-label="La mia posizione">
      <span class="material-icons">my_location</span>
    </button>

    <!-- Current location indicator -->
    <div class="current-location">
      <div class="current-location__icon">
        <span class="material-icons">place</span>
      </div>
      <div class="current-location__info">
        <span class="current-location__label">Posizione attuale</span>
        <span class="current-location__name">{{ currentLocationName() }}</span>
      </div>
      <span class="material-icons current-location__arrow">arrow_drop_down</span>
    </div>
  </div>

  <!-- Section title: Scopri fiutami speciali -->
  <div class="section-title">
    <h2>Scopri fiutami speciali vicino a te</h2>
  </div>

  <!-- Promo banner FIUTAMI Plus -->
  <div class="promo-banner" (click)="goToPremium()">
    <div class="promo-banner__content">
      <p class="promo-banner__text">Fiuta a pieno, con il Plus</p>
      <button class="promo-banner__button">Scopri</button>
    </div>
    <div class="promo-banner__indicator">
      <span class="dot active"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  </div>

  <!-- POI Card (bottom sheet overlay) -->
  @if (selectedPOI(); as poi) {
    <div class="poi-card" (click)="$event.stopPropagation()">
      <button class="poi-card__close" (click)="closePOICard()">
        <span class="material-icons">close</span>
      </button>

      <div class="poi-card__header">
        <div class="poi-card__type-badge" [style.background-color]="markerColors[poi.type]">
          {{ poi.type | titlecase }}
        </div>
        <h3 class="poi-card__name">{{ poi.name }}</h3>
        <p class="poi-card__address">{{ poi.address }}</p>
      </div>

      <div class="poi-card__details">
        @if (poi.rating) {
          <div class="poi-card__rating">
            <span class="material-icons star">star</span>
            <span class="rating-value">{{ formatRating(poi.rating) }}</span>
            @if (poi.reviewCount) {
              <span class="review-count">({{ poi.reviewCount }})</span>
            }
          </div>
        }
        @if (poi.distance) {
          <div class="poi-card__distance">
            <span class="material-icons">place</span>
            <span>{{ formatDistance(poi.distance) }}</span>
          </div>
        }
      </div>

      <div class="poi-card__actions">
        <button class="poi-action-btn poi-action-btn--directions" (click)="openDirections(poi)">
          <span class="material-icons">directions</span>
          <span>Indicazioni</span>
        </button>
        <button
          class="poi-action-btn poi-action-btn--save"
          [class.poi-action-btn--saved]="poi.isFavorite"
          (click)="toggleFavorite(poi)">
          <span class="material-icons">{{ poi.isFavorite ? 'bookmark' : 'bookmark_border' }}</span>
          <span>{{ poi.isFavorite ? 'Salvato' : 'Salva' }}</span>
        </button>
      </div>
    </div>
  }

  <!-- Mascot Bottom Sheet (mantenuto per AI chat) -->
  <app-mascot-bottom-sheet
    [isOpen]="showMascotSheet()"
    [hideMascot]="true"
    [aiMessage]="'Ciao! Come posso aiutarti a trovare luoghi pet-friendly?'"
    (closed)="closeMascotSheet()">
  </app-mascot-bottom-sheet>

</app-tab-page-shell-default>
